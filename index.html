<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Kata Lispy Lang</title>
    <script src="lang.js"></script>
</head>

<body>
    <script id="src" type="text/lisp">

    (module Prelude
        (export + * map)

        (let
            :native + """
            
            function ($s, seed) {
                return $Array_slice.call(arguments, 2).reduce(function (a, b) {
                    return a + b;
                }, seed);
            }

            """

            :native * """
            
            function ($s, seed) {
                return $Array_slice.call(arguments, 2).reduce(function (a, b) {
                    return a * b;
                }, seed);
            }

            """

            :native map """

            function ($, f, xs) {
                return xs.map(function (x) { return f($s, x); });
            }

            """
        )
    )

    (module Demo/Math
        """
        A doc comment.
        with some escaped \""" stuff
        """
        (import Prelude + *)
        (export inc square)

        ; A line comment
        (fn square [x] (* x x))
        (fn inc [x] (+ x 1))
    )

    (module ;:main
        (import System/Prelude + map)
        (import System/Unsafe/ECMAScript :as js)
        (import Demo/Math square)

        (fn inc [x] (+ x 1))
        (let
            nat (map (fn [x] (+ x 1 (inc -1))) [0 1 2])
            fib [{:k :v} 1 1 2 3 5 8 13 []]
            literal "A string with ; and escaped \" stuff"
            msg { :type "do_it" :payload { :one 1 } }
            almost-pi (inc 2.14159265)
        )
        (js/console.log "Hello, World!" nat [:x] almost-pi fib literal msg js/Math.PI)
    )

    </script>
    <script>

        const code = document.querySelector("#src").innerText;
        console.log(code);
        const ast = Lang.parse(code);
        console.log("AST", ast);
        const annotated = Lang.annotate(ast);
        console.log("annotated AST", annotated);
        const reconstructed = Lang.print(annotated);
        console.log(reconstructed);
        const generated = Lang.generate(annotated);
        console.log(generated);

        const script = document.createElement("script");
        script.appendChild(document.createTextNode(generated));
        document.body.appendChild(script);

    </script>
</body>

</html>